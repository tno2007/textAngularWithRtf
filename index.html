<body>
  <div ng-app="app">
    <div ng-controller="TextEditController">
      <text-angular
        name="pasteListener"
        ng-model="htmlVariable"
        ta-paste="modifyHtml($html, $textPlainContent, $textRtfContent, $textHtmlContent)"
        ta-text-editor-class="border border:2 border-color:gold-60"
        ta-html-editor-class="border border:2 border-color:gold-60"
      ></text-angular>

      <br />

      <textarea name="input" id="input" class="w:100% h:250"></textarea>

      <div id="output"></div>
    </div>
  </div>

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/tno2007/textAngularWithRtf@latest/dist/textAngular.css"
  />
  <!-- pull fontawesome to show editor icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <script src="https://cdn.master.co/css"></script>

  <!-- cleandocx -->
  <script src="https://cdn.jsdelivr.net/gh/tno2007/docx-cleaner-es5@latest/dist/cleandocx.umd.js"></script>

  <!-- non minified -->
  <script src="https://cdn.jsdelivr.net/npm/angular@1.3.11/angular.js"></script>
  <script src="dist/textAngular-rangy.min.js"></script>
  <script src="dist/textAngular-sanitize.js"></script>
  <script src="dist/textAngular.js"></script>
  <script src="dist/textAngularSetup.js"></script>

  <!-- minified -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/angular@1.3.11/angular.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/tno2007/textAngularWithRtf@latest/dist/textAngular-rangy.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/tno2007/textAngularWithRtf@latest/dist/textAngular-sanitize.min.js"></script>
  <script src="dist/textAngular.min.js"></script>  -->

  <script>
    var readSyncDataURL = function (file) {
      var url = URL.createObjectURL(file);
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, false); //Synchronous XMLHttpRequest on Object URL
      xhr.overrideMimeType("text/plain; charset=x-user-defined"); //Override MIME Type to prevent UTF-8 related errors
      xhr.send();
      URL.revokeObjectURL(url);
      var returnText = "";
      for (var i = 0; i < xhr.responseText.length; i++) {
        returnText += String.fromCharCode(
          xhr.responseText.charCodeAt(i) & 0xff
        );
      } //remove higher byte
      return "data:" + file.type + ";base64," + btoa(returnText);
    };

    document.addEventListener("DOMContentLoaded", function () {
      var input = document.getElementById("input");
      var output = document.getElementById("output");

      input.addEventListener("paste", function (event) {
        try {
          var finalHtml;
          var images;
          var textHtmlContent, textRtfContent, textPlainContent, filesContent;

          // print out the list of clipboard types
          console.log(event.clipboardData.types);

          // capture html content
          if (/text\/html/i.test(event.clipboardData.types))
            textHtmlContent = event.clipboardData.getData("text/html");

          // console.log(textHtmlContent);

          // capture rtf content
          if (/text\/rtf/i.test(event.clipboardData.types))
            textRtfContent = event.clipboardData.getData("text/rtf");

          // capture plain text content
          if (/text\/plain/i.test(event.clipboardData.types))
            textPlainContent = event.clipboardData.getData("text/plain");

          // capture files content
          if (/Files/i.test(event.clipboardData.types)) {
            filesContent = event.clipboardData.files;

            // create a div element to store images
            images = document.createElement("div");

            // make sure the files are images
            for (var i = 0; i < filesContent.length; i++) {
              var file = filesContent[i];

              if (!file.type.match("image/*")) {
                console.log(`File '${file.name}' is not an image`);
                continue;
              }

              var dataUri = readSyncDataURL(file);

              var img = document.createElement("img");
              img.src = dataUri;
              images.appendChild(img);
            }
          }

          // premutations

          // 1. images only
          // do we have images present?
          if (images && !textHtmlContent && !textPlainContent) {
            finalHtml = images.innerHTML;
          }
          // 2. html content
          // do we have html content present?
          if (textHtmlContent) {
            finalHtml = textHtmlContent;
          }

          // 3. plain text content only
          // do we have plain text content present?
          if (textPlainContent && !textHtmlContent) {
            // wrap plain text content in a span
            finalHtml = `<span>${textPlainContent}</span>`;
          }

          console.log("finalHtml", finalHtml);

          var cleanHtml;

          cleanHtml = cleanDocx.cleanDocx(finalHtml, textRtfContent);
          // cleanHtml = finalHtml;

          // console.log("cleanHtml", cleanHtml);

          // output.innerHTML = cleanHtml;

          // convert cleanHtml to html dom element
          var div = document.createElement("div");
          div.innerHTML = cleanHtml;

          // append the cleanHtml to the output
          output.append(div);
        } catch (error) {
          console.log("Error !!!", error);
        }
      });
    });
  </script>

  <!--
    // Working
    'text/plain'
    'text/plain', 'text/html'
    Â ['text/html', 'Files']

    // Not working


-->

  <script>
    angular
      .module("app", ["textAngular"])
      .controller("TextEditController", function ($scope) {
        $scope.htmlVariable = "";
        $scope.message = "Hello textAngular!";

        $scope.modifyHtml = function (
          $html,
          $textPlainContent,
          $textRtfContent,
          $textHtmlContent
        ) {
          // check if html and rtf content is present
          if ($textHtmlContent && $textRtfContent) {

            // clean the html content
            var cleanHtml = cleanDocx.cleanDocx($textHtmlContent, $textRtfContent);

            var regEx = new RegExp('<!--[\\s\\S]*?(?:-->)', 'g')
            var strippedHtml = cleanHtml.replace(regEx, "");

            $html = strippedHtml;
          }

          // check if html content is not present
          if (!$textHtmlContent && $textPlainContent) {
            $html = "<span>" + $textPlainContent + "</span>";
          }

          return $html;
        };
      });
  </script>
</body>
